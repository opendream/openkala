{% extends "base.html" %}

{% block script %}
<script type="text/javascript" src="{{ STATIC_URL }}openkala/plan.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}openkala/corestandard.js"></script>

<script type="text/javascript" charset="utf-8">
    var project_id = {{ project.id }};

    function saveEditableHelper(arg1, arg2, jqobj, val) {
        if (jqobj || GENTICS.Aloha.isModified()) {
            if (jqobj) {
                var dom    = jqobj;
                var code   = jqobj.attr('id').split('-');
            }
            else {
                var dom    = GENTICS.Aloha.getActiveEditable().obj;
                var code   = GENTICS.Aloha.getActiveEditable().getId().split('-');
            }

            if (code[0] == 'Plan' && !jqobj) {
                var model  = code[0], field = code[1], week = $('#week_options').val();
                var attr   = {};

                attr['week'] = week;
                attr['project'] = project_id;
                attr[field] = dom.html();

                $.ajax({
                    'url': '/api/' + model.toLowerCase() + 's',
                    'type': 'POST',
                    'dataType': 'json',
                    'data': (attr),
                    'beforeSend' : function(xhr) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    },
                    'success': function (data) {
                        $.each(data, function (field_name, val) {
                            $('#' + model + '-' + field_name).html(val);
                        });
                        $('input#current-plan-id').val(data['id']);
                    }
                });
            }
            else if (code[0] == 'Task') {
                var model  = code[0], day = code[1], field  = code[2], week = $('#week_options').val();
                var attr   = {};

                attr['day'] = day;
                attr['plan'] = $('input#current-plan-id').val();
                attr[field] = dom.html();

                $.ajax({
                    'url': '/api/' + model.toLowerCase() + 's',
                    'type': 'POST',
                    'dataType': 'json',
                    'data': (attr),
                    'beforeSend' : function(xhr) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    },
                    'success': function (data) {
                        $.each(data, function (field_name, val) {
                            $('#' + model + '-' + day + '-' + field_name).html(val);
                        });
                    }
                });
            }
            else {
                var model  = code[0], id = code[1], field  = code[2];
                var attr   = {};

                attr['id'] = id;

                attr[field] = val? val: dom.html();
                if (val === false) {
                    attr[field] = 0;
                }

                $.ajax({
                    'url': '/api/' + model.toLowerCase() + 's',
                    'type': 'POST',
                    'dataType': 'json',
                    'data': (attr),
                    'beforeSend' : function(xhr) {
                        xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                    },
                    'success': function (data) {
                        $.each(data, function (field_name, val) {
                            $('#' + model + '-' + id + '-' + field_name).html(val);
                        });
                    }
                });
            }

        };
    }

    function saveEditable(jqobj, val) {
        saveEditableHelper(null, null, jqobj, val);
    }

    Ext.onReady(function() {

      repositories.CoreStandard.settings.data = [
      {% for std in coreStandards %}
          { id: {{ std.id }}, name: '{{ std.code }}', url: '/coreStandard/{{ std.id }}', type: 'standard'},
      {% endfor %}
      ]

      
      GENTICS.Aloha.settings = {
          "i18n": {"current": "en"},
          "ribbon": false,
          "plugins": {
            "com.gentics.aloha.plugins.Link": {
                
            },
            "com.gentics.aloha.plugins.GCN": { 
              "enabled": true 
            },
            "com.gentics.aloha.plugins.Format": { 
              config : [ 'b', 'i','u','del','sub','sup', 'p', 'title', 'h1', 'h2', 'h3', 'h4', 
    'h5', 'h6', 'pre', 'removeFormat'],
            } 
          }
        };
      $('.editable').aloha();
      
      GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha, "editableDeactivated", saveEditableHelper);

      $('.menu').tabify();


      // init plan
      planHandler.init( {{project.id }} , '{{ STATIC_URL }}' );
      planHandler.load(1);
      
    });
</script>
{% endblock %}

{% block title %}โครงงาน : {{ project.name }}{% endblock %}


{% block breadcrumb %}
<li><a href="{% url quarter_project_list %}">โครงงาน</a></li>
<li>{{ project.name }}</li>
{% endblock %}

{% block header %}
<div class="grid_16"><div class="ignore"><h1>โครงงาน : <span id="Project-{{ project.id }}-name" class="editable">{{ project.name }}</span></h1></div></div>
<div class="grid_3"><div class="ignore"><p>ชั้นประถมศึกษาปีที่ : <span id="Project-{{ project.id }}-grade" class="editable">{{ project.grade }}</span></p></div></div>
<div class="grid_3"><div class="ignore"><p>ปีการศึกษา : <span id="Project-{{ project.id }}-year" class="editable">{{ project.year }}</span></p></div></div>
<div class="grid_3"><div class="ignore"><p>ภาคเรียน : <span id="Project-{{ project.id }}-quarter" class="editable">{{ project.quarter }}</span></p></div></div>
<div class="clearfix"></div>
{% endblock %}

{% block content %}

<ul id="menu" class="menu">
  <li id="tab-topic" class="active"><a href="#topic">สาระ</a></li>
  <li><a id="tab-plan" href="#plan">แผน</a></li>
  <li><a id="tab-standard" href="#standard">มาตรฐาน</a></li>
</ul>

<div id="topic" class="content">
    <div class="thead topic-first">
        <div class="grid_{{ grid_topic }}"><div class="ignore header_1">สาระการเรียนรู้</div></div>
        <div class="left">
            <div class="standard_header header_2">มาตรฐานการเรียนรู้และตัวชี้วัด</div>
            {% for header in standard_header %}
            <div class="grid_{{ grid }}"><div class="ignore header_2">{{ header.title|safe }}</div></div>
            {% endfor %}
        </div>
        <div class="grid_{{ grid_plan }}"><div class="ignore header_1">สัปดาห์</div></div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody topic-first">
        {% include "topic_items.html" %}
    </div>
</div>
<div id="plan" class="content">

    <div class="toolbar">
        <div>
            สัปดาห์ :
            <select id="week_options">
                {% for i in weeks %}
                <option>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <form><input id='current-plan-id' type="hidden" value=""/></form>

    <div class="thead plan-first">
        <div class="grid_4"><div class="ignore hrow">สาระสำคัญ<br />Main Point</div></div>
        <div class="grid_8"><div class="ignore hrow">เป้าหมายหลัก<br />Goal</div></div>
        <div class="grid_4"><div class="ignore hrow">เนื้อหา/กิจกรรม ชิ้นงาน<br />Content/Activity Work</div></div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody plan-first">
        <div class="item odd">
          <div class="grid_4">
              <div id="Plan-main_point" class="editable ignore">-</div>
          </div>
          <div class="grid_8">
              <div id="Plan-goal" class="editable ignore">-</div>
          </div>
          <div class="grid_4">
              <div id="Plan-activity" class="editable ignore">-</div>
          </div>
          <div class="clearfix"></div>
        </div>
    </div>
    <br/>
    <hr/>
    <div class="thead plan-second">
        <div class="grid_5"><div class="ignore hrow">หัวเรื่อง<br />Sub-Topic</div></div>
        <div class="grid_3"><div class="ignore hrow">เครื่องมือการคิด<br />Key Thinking</div></div>
        <div class="grid_4"><div class="ignore hrow">พฤติกรรมที่แสดงว่าเข้าใจ<br />Understanding Performance</div></div>
        <div class="grid_4"><div class="ignore hrow">การประเมิณ<br />Assessment</div></div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody plan-second">
        <div class="item odd">
            <div class="grid_5">
                <div id="Plan-sub_topic" class="editable ignore">-</div>
            </div>
            <div class="grid_3">
                <div id="Plan-key_thinking" class="editable ignore">-</div>
            </div>
            <div class="grid_4">
                <div id="Plan-performance" class="editable ignore">-</div>
            </div>
            <div class="grid_4">
                <div id="Plan-assessment" class="editable ignore">-</div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
    <br/>
    <hr/>
    <div class="thead task">
        <div class="grid_2 hcol"><div class="ignore">วัน<br />Day</div></div>
        <div class="grid_6 hcol"><div class="ignore">กิจกรรมการเรียนรู้<br />Activities</div></div>
        <div class="grid_4 hcol"><div class="ignore">สื่อ/แหล่งเรียนรู้<br />Sources</div></div>
        <div class="grid_4 hcol"><div class="ignore">ชิ้นงาน<br />Work</div></div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody task">
        {% for day, display in days %}
        <div class="item {% cycle 'odd' 'even' as rowtype %}">
            <div class="grid_2">
                <div class="ignore hrow">
                    <div class="day-label">{{ display }}</div>
                    <div class="day-wrap"><div id="Task-{{ day }}-hour" class="editable ignore day-hour">-</div> <span class="suffix">ชม.</span></div>
                </div>
            </div>
            <div class="grid_6">
                <div id="Task-{{ day }}-activity" class="editable ignore">-</div>
            </div>
            <div class="grid_4">
                <div id="Task-{{ day }}-source" class="editable ignore">-</div>
            </div>
            <div class="grid_4">
                <div id="Task-{{ day }}-work" class="editable ignore">-</div>
            </div>
            <div class="clearfix"></div>
        </div>
        {% endfor %}
    </div>
    <div class="clear"></div>
</div>
<div id="standard" class="content">
    <div class="thead standard">
        <div class="grid_3"><div class="ignore hrow">ข้อมาตรฐาน</div></div>
        <div class="grid_10"><div class="ignore hrow">คำอธิบาย</div></div>
        <div class="grid_3"><div class="ignore hrow">อยู่ในแผนแล้ว</div></div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody standard">
        {% for standard in standards %}
        <div class="item {% cycle 'odd' 'even' as rowtype %}">
            <div class="grid_3" style="display:none;">
                <div id="CoreStandard-{{ standard.id }}-group_code" class="ignore CoreStandard-group_code">{{ standard.group_code }}</div>
            </div>
            <div class="grid_3">
                <div id="CoreStandard-{{ standard.id }}-code" class="ignore CoreStandard-code">{{ standard.code|safe }}</div>
            </div>
            <div class="grid_10">
                <div id="CoreStandard-{{ standard.id }}-description" class="ignore CoreStandard-description">{{ standard.description|safe }}</div>
            </div>
            <div class="grid_3">
                <div id="CoreStandard-{{ standard.id }}-status" class="ignore CoreStandard-status"><div class="status">No</div></div>
            </div>
            <div class="clearfix"></div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

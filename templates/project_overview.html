{% extends "base.html" %}

{% block script %}
<script type="text/javascript" charset="utf-8">
    Ext.onReady(function() {
      function saveEditable() {
          if (GENTICS.Aloha.isModified()) {
              objID = GENTICS.Aloha.getActiveEditable().getId().split('-')[1];
              attrs = [];
              $(".topic-"+objID).each(function (i, item) {
                st = {};
                st['standard' + (i+1)] = $(this).html();
                attrs.push(st);
              });
              console.log(attrs);
          };
      }

      repositories = {
          CoreStandard: new GENTICS.Aloha.Repository('CoreStandard')
      }
      repositories.CoreStandard.settings.data = [
          { id: 1, name: 'ว 1.1', url: '/coreStandard/1', type: 'standard'},
          { id: 2, name: 'ว 1.2', url: '/coreStandard/2', type: 'standard'},
          { id: 3, name: 'ว 2.1', url: '/coreStandard/3', type: 'standard'},
          { id: 4, name: 'ว 2.2', url: '/coreStandard/4', type: 'standard'}
      ]
      repositories.CoreStandard.query = function(p, callback) {
          var d = this.settings.data.filter(function (e, i) {
              var r = new RegExp(p.queryString, 'i');
              var ret = false;

              return (
                  jQuery.inArray(e.type, p.objectTypeFilter) > -1 &&
                    ( e.name.match(r) )
              )
          });
          callback.call(this, d);
      }
      repositories.CoreStandard.markObject = function(obj, resourceItem) {
          console.log('mark object');
          CoreStandard.updateCoreStandard(obj, resourceItem);
      }

      CoreStandard = new GENTICS.Aloha.Plugin('CoreStandard');
      CoreStandard.init = function() {
          var that = this;
          var insertButton = new GENTICS.Aloha.ui.Button({
              'iconClass': 'button_core_standard',
              'size': 'small',
              'onclick': function() {
                  that.insertCoreStandard();
              },
              'tooltip': 'มาตรฐาน',
              'toggle': false
          });
          GENTICS.Aloha.FloatingMenu.addButton(
              'GENTICS.Aloha.continuoustext',
              insertButton,
              'มาตรฐาน',
              1
          );

          GENTICS.Aloha.FloatingMenu.createScope(this.getUID('coreStandard'), 'GENTICS.Aloha.global');
          this.coreStandardField = new GENTICS.Aloha.ui.AttributeField();
          this.coreStandardField.setTemplate('<span>{name}<br class="clear" /></span>');
          this.coreStandardField.setObjectTypeFilter(['standard']);
          this.coreStandardField.setDisplayField('name');
          GENTICS.Aloha.FloatingMenu.addButton(
              this.getUID('coreStandard'),
              this.coreStandardField,
              'มาตรฐาน'
          )

          GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha, 'selectionChanged', function(event, rangeObject) {
              var foundMarkup = that.findTag( rangeObject );
              jQuery('.core-standard-selected').removeClass('core-standard-selected');
              
              if ( foundMarkup.length != 0 ) {
                  GENTICS.Aloha.FloatingMenu.setScope(that.getUID('coreStandard'));
                  that.coreStandardField.setTargetObject(foundMarkup, 'data-core-standard-name');
                  
                  foundMarkup.addClass('core-standard-selected');
              }
              // re-layout the Floating Menu
              GENTICS.Aloha.FloatingMenu.doLayout();
          });

          GENTICS.Aloha.EventRegistry.subscribe(
              GENTICS.Aloha, 
              "editableDeactivated", 
              function (jEvent, aEvent) {
                    jQuery('.core-standard-selected').removeClass('core-standard-selected');
              }
          );

      };

      CoreStandard.findTag = function(range) {
          return jQuery(range.commonAncestorContainer).closest('.GENTICS_block.core-standard');
      };

      CoreStandard.insertCoreStandard = function() {
          GENTICS.Aloha.FloatingMenu.userActivatedTab = ('มาตรฐาน');
          var range = GENTICS.Aloha.Selection.getRangeObject();
          var tpl = jQuery('<span class="GENTICS_block core-standard" contentEditable="false">' +
            '<span class="name">CODE</span></span>');
          
          GENTICS.Utils.Dom.insertIntoDOM(tpl, range, jQuery(GENTICS.Aloha.activeEditable.obj));
          range.startContainer = range.endContainer = tpl.contents().get(0);
          range.select();
          this.coreStandardField.focus();
      }

      CoreStandard.updateCoreStandard = function(obj, resourceItem) {
          obj.find('.name').text(resourceItem.name);
      }

      
      GENTICS.Aloha.settings = {
          "i18n": {"current": "en"},
          "ribbon": false,
          "plugins": {
            "com.gentics.aloha.plugins.Link": {
                
            },
            "com.gentics.aloha.plugins.GCN": { 
              "enabled": true 
            },
            "com.gentics.aloha.plugins.Format": { 
              config : [ 'b', 'i','u','del','sub','sup', 'p', 'title', 'h1', 'h2', 'h3', 'h4', 
    'h5', 'h6', 'pre', 'removeFormat'],
            } 
          }
        };
      $('.editable').aloha();
      
      GENTICS.Aloha.EventRegistry.subscribe(GENTICS.Aloha, "editableDeactivated", saveEditable);
    });
</script>
{% endblock %}

{% block title %}Project: {{ project.name }}{% endblock %}

{% block header %}
<div class="grid_16"><h1>Project: <span class="editable">{{ project.name }}</span></h1></div>
<div class="grid_3"><p>Grade : <span class="editable">{{ project.grade }}</span></p></div>
<div class="grid_3"><p>Year : <span class="editable">{{ project.year }}</span></p></div>
<div class="grid_3"><p>Quarter : <span class="editable">{{ project.quarter }}</span></p></div>
<div class="clearfix" />
{% endblock %}

{% block content %}
<div id="content">
    <div class="thead">
        <div class="grid_4">Topics</div>
        <div class="grid_2">{{ project.standard_header1 }}</div>
        <div class="grid_2">{{ project.standard_header2 }}</div>
        <div class="grid_2">{{ project.standard_header3 }}</div>
        <div class="grid_2">{{ project.standard_header4 }}</div>
        <div class="grid_2">{{ project.standard_header5 }}</div>
        <div class="grid_2">Plan</div>
        <div class="clearfix"></div>
    </div>
    <div class="tbody">
        {% include "topic_items.html" %}
    </div>
</div>
{% endblock %}
